name: Kotlin Eap Test
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 6"

jobs:
  test-no-eap:
    name: Compile normally
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 15
        uses: actions/setup-java@v1
        with:
          java-version: 15

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compile
        run: |
          ./gradlew assemble

  test-kotlin-eap:
    name: Compile with Kotlin eap
    runs-on: ubuntu-latest
    continue-on-error: true


    outputs:
      was-ice: ${{ steps.was-ice.outputs.files_exists }}
    env:
      ORG_GRADLE_PROJECT_kotlinEap: "latest"
      ORG_GRADLE_PROJECT_reportICEs: "true"
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 15
        uses: actions/setup-java@v1
        with:
          java-version: 15

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compile
        run: |
          ./gradlew assemble


      - name: Check for ICE report
        if: ${{ failure() }}
        id: was-ice
        uses: andstor/file-existence-action@v1.0.1
        with:
          files: ".kotlin-future-testing-ICE-report"

      - name: Archive ICE report
        uses: actions/upload-artifact@v2
        if: ${{ failure() && steps.was-ice.outputs.files_exists == 'true' }}
        with:
          name: future-ice-report
          path: .kotlin-future-testing-ICE-report

  check-results:
    name: Results
    needs: [ test-no-eap, test-kotlin-eap ]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Original Compile Failed
        if: ${{ needs.test-no-eap.result != 'success' }}
        run: echo "::warning::Compilation without eap failed, aborting"

      - name: Eap Compile failed
        if: ${{ needs.test-no-eap.result == 'success' && needs.test-kotlin-eap.result != 'success' }}
        run: echo "::error::Compilation with Kotlin eap failed"


      - name: Download ICE report
        if: ${{ needs.test-kotlin-eap.outputs.was-ice == 'true' }}
        uses: actions/download-artifact@v2
        with:
          name: future-ice-report
      - name: Save git info
        if: ${{ needs.test-kotlin-eap.outputs.was-ice == 'true' }}
        run: |
          touch .kotlin-future-testing-run-info
          'echo "Workflow: ${{ github.repository }}/${{ github.workflow }}#${{ github.run_number }}" >> .kotlin-future-testing-run-info'
          'echo "Git Ref: ${{ github.ref }}, SHA: ${{ github.sha }}" >> .kotlin-future-testing-run-info'
          'echo "Run ID: ${{ github.run_id }}" >> .kotlin-future-testing-run-info'

      - name: Archive ICE report
        uses: actions/upload-artifact@v2
        if: ${{ needs.test-kotlin-eap.outputs.was-ice == 'true' }}
        with:
          name: future-ice-report
          path: |
            .kotlin-future-testing-ICE-report
            .kotlin-future-testing-run-info
                